<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Smart Home</title>
  <%= include_gon %>
  <%= favicon_link_tag %>
  <%= stylesheet_link_tag    'application', media: 'all', 'data-turbolinks-track' => true %>
  <%= javascript_include_tag 'application', 'data-turbolinks-track' => true %>
  <%= csrf_meta_tags %>
</head>
<body>
<%= render 'layouts/navbar' %>
<% if user_signed_in? %>
<div id="mic" data-target="#myModal" data-toggle="modal"><%= fa_icon "microphone", style: "font-size: 25px;"%></div>
<%= render 'layouts/speech' %>
<% end %>
<div class="container-fluid">
	<%if params[:controller] == 'pages' %>
	<div class= "row1">
	<% flash.each do |name, msg| %>
			<% if msg.is_a?(String) %>
				<div class="alert alert-<%= name == "notice" ? "success" : "danger"%> alert-dismissble">
					<button type="button" class="close" data-dismiss="alert"><span aria-hidden="true">&times;</span><span class="sr-only"> Close</span></button>
					<%= content_tag :div,msg, :id=> "flash_#{name}" %>
				</div>
			<% end %>
			<% end %>
	<%= yield %>
</div>
	<% else %>
	<div class="row">
		<%= render 'layouts/sidebar' %>
		<div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
			<% flash.each do |name, msg| %>
			<% if msg.is_a?(String) %>
				<div class="alert alert-<%= name == "notice" ? "success" : "danger"%> alert-dismissble">
					<button type="button" class="close" data-dismiss="alert"><span aria-hidden="true">&times;</span><span class="sr-only"> Close</span></button>
					<%= content_tag :div,msg, :id=> "flash_#{name}" %>
				</div>
			<% end %>
		<% end %>
		<%= yield %>
	</div>
	</div>
	<% end %>
</div>
<script type="text/javascript">
if(gon.logged_in){
    
   var accessToken = "66b0de1a2ecd46afb4f25abcb9cc278c",
      subscriptionKey = "82cb8764-2927-45c5-8043-a614e9cd8a19",
      baseUrl = "https://api.api.ai/v1/",
      $speechInput,
      $recBtn,
      recognition,
      messageCouldntHear = "I couldn't hear you, could you say that again?",
      messageInternalError = "Oh no, there has been an internal server error",
      messageSorry = "I'm sorry, I don't have the answer to that yet.";
// Test browser support
window.SpeechRecognition = window.SpeechRecognition  ||
                              window.webkitSpeechRecognition ||
                                 null;
var results = [];
if (window.SpeechRecognition === null) {
  document.getElementById('ws-unsupported').classList.remove('hidden');
  var div = document.getElementById('button-play-ws');
  div.innerHTML = '<%= fa_icon "microphone-slash", style: "font-size: 25px;" %>';
  var div2 = document.getElementById('mic');
  div2.innerHTML = '<%= fa_icon "microphone-slash", style: "font-size: 25px;" %>';
  div2.className += "disabled";
  document.getElementById('button-play-ws').setAttribute('disabled', 'disabled');
  document.getElementById('button-stop-ws').setAttribute('disabled', 'disabled');
} 
else {
  var recognizer = new window.SpeechRecognition();
  var transcription = document.getElementById('transcription');
  var log = document.getElementById('log');
  // Recogniser doesn't stop listening even if the user pauses
  // recognizer.continuous = true;
  // Start recognising
  recognizer.onresult = function(event) {
    transcription.textContent = '';
    log.innerHTML = '';
    results.push(event.results);
    results.reverse();
    results.forEach(function(val,i){
      var el = val[0][0].transcript.toLowerCase();
      transcription.textContent = el;
      $.ajax({
        type: "POST",
        url: baseUrl + "query/",
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        headers: {
          "Authorization": "Bearer " + accessToken,
          "ocp-apim-subscription-key": subscriptionKey
        },
        data: JSON.stringify({q: el, lang: "en"}),
        success: function(data) {
          prepareResponse(data);
        },
        error: function() {
          log.innerHTML = messageInternalError;
        }
      });
    });
    results = [];
  };
  function prepareResponse(val) {
      var debugJSON = JSON.stringify(val, undefined, 2),
        spokenResponse = val.result.speech,i,match=0;
        if (spokenResponse == ""){
          spokenResponse = val.result.metadata.html;
        }
        else{
          if(val.result.parameters.device){
            for(i=0;i<gon.devices.length;i++) {
              if(val.result.parameters.device.search(gon.devices[i].name.toLowerCase())){
                var id = gon.devices[i].id;
                match++;
                if(val.result.action == "turnon"){
                  if(gon.devices[i].state){
                    log.innerHTML = "The device is already on.";
                  }
                  else{
                    $.get("/devices/turn_on",{"id":id});  
                  }
                }
                else if(val.result.action == "turnoff"){
                  if(gon.devices[i].state){
                    $.get("/devices/turn_on",{"id":id});
                  }
                  else{
                     log.innerHTML = "The device is already off.";
                  }
                }
              }
            }
            if(val.result.parameters.device == "all devices"){
                match++;
                if(val.result.action == "turnon"){
                  $.get("/devices/turn_on_all");
                }
                else if(val.result.action == "turnoff"){
                  $.get("/devices/turn_off_all");
                }
              }
            if(match==0){
              log.innerHTML = "Sorry but either you haven't added that device or you don't have permission to use it."
            }
          }
        }
        if(match==0){
          if(val.result.action.search("smalltalk") != -1 || val.result.action.search("name") != -1 ||Â val.result.action.search("calculator") != -1){
            log.innerHTML = spokenResponse;    
          }
          else{
            log.innerHTML = messageSorry;
          }
        }
      console.log(debugJSON);
    }

  // Listen for errors
  recognizer.onerror = function(event) {
    //log.innerHTML = 'Recognition error: ' + event.message + '<br />' + log.innerHTML;
    transcription.textContent = '';
    log.innerHTML = messageCouldntHear;
  };
  var play = document.getElementById('button-play-ws');
  play.addEventListener('click', function() {
    // Set if we need interim results
    recognizer.interimResults = document.querySelector('input[name="recognition-type"][value="interim"]').checked;
    recognizer.stop();
    try {
      transcription.textContent = 'Listening...';
      log.textContent = 'What can I do for you?';
      recognizer.start();
    } catch(ex) {
      log.innerHTML = messageCouldntHear;
      transcription.textContent = '';
    }
  });
  document.getElementById('mic').addEventListener('click', function() {
      try {
      transcription.textContent = 'Listening...';
      log.textContent = 'What can I do for you?';
      recognizer.start();
    } catch(ex) {
      log.innerHTML = messageCouldntHear;
      transcription.textContent = '';
    }
  });
}
}
</script>
</body>
</html>
